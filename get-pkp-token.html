<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get PKP Token ID - Regav Trading Agent</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .step { margin: 20px 0; padding: 15px; border-left: 4px solid #007cba; background: #f8f9fa; }
        .token-display { background: #e8f4f8; padding: 15px; border-radius: 4px; margin: 10px 0; font-family: monospace; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a8b; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîë Get Your PKP Token ID for Trading Agent</h1>
        
        <div class="step">
            <h3>Step 1: Start Vincent Consent Flow</h3>
            <p>Try these Vincent consent URLs manually if the button doesn't work:</p>
            <div class="token-display">
                <strong>Option 1:</strong> <a href="https://vincent.domains/consent?appId=983&redirectUrl=file:///Users/pc/regav-ai/get-pkp-token.html" target="_blank">https://vincent.domains/consent?appId=983</a><br>
                <strong>Option 2:</strong> <a href="https://app.vincent.domains/consent?appId=983&redirectUrl=file:///Users/pc/regav-ai/get-pkp-token.html" target="_blank">https://app.vincent.domains/consent?appId=983</a><br>
                <strong>Option 3:</strong> <a href="https://staging.vincent.domains/consent?appId=983&redirectUrl=file:///Users/pc/regav-ai/get-pkp-token.html" target="_blank">https://staging.vincent.domains/consent?appId=983</a>
            </div>
            <button onclick="startConsentFlow()">üöÄ Start Vincent Consent Flow</button>
            <p><em>Note: If pop-ups are blocked, manually click the links above</em></p>
        </div>

        <div class="step">
            <h3>Step 2: Complete Authorization</h3>
            <p>After clicking above, you'll be redirected to Vincent where you need to:</p>
            <ul>
                <li>Connect your wallet</li>
                <li>Approve the trading permissions</li>
                <li>Authorize the Regav Trading Agent</li>
            </ul>
        </div>

        <div class="step">
            <h3>Step 3: Extract PKP Token ID</h3>
            <p>After completing consent, you'll be redirected back here with your authentication info.</p>
            <div id="tokenResult"></div>
            <button onclick="extractTokenFromStorage()">üîç Extract PKP Token ID from Storage</button>
        </div>

        <div class="step">
            <h3>Step 4: Update Your .env File</h3>
            <p>Once you get your PKP Token ID, update your <span class="code">.env</span> file:</p>
            <div id="envUpdate"></div>
        </div>

        <div class="step">
            <h3>Alternative: Check URL Parameters</h3>
            <p>If you were redirected here from Vincent, check for authentication parameters:</p>
            <button onclick="checkUrlParams()">üîó Check URL Parameters</button>
            <div id="urlParams"></div>
        </div>
    </div>

    <script>
        // Vincent App Configuration
        const VINCENT_CONFIG = {
            appId: '983',
            appName: 'Regav Trading Agent',
            redirectUrl: window.location.origin + window.location.pathname,
            environment: 'datil-dev'
        };

        function startConsentFlow() {
            // Try multiple Vincent endpoints
            const consentUrls = [
                `https://vincent.domains/consent?appId=${VINCENT_CONFIG.appId}&redirectUrl=${encodeURIComponent(VINCENT_CONFIG.redirectUrl)}`,
                `https://app.vincent.domains/consent?appId=${VINCENT_CONFIG.appId}&redirectUrl=${encodeURIComponent(VINCENT_CONFIG.redirectUrl)}`,
                `https://staging.vincent.domains/consent?appId=${VINCENT_CONFIG.appId}&redirectUrl=${encodeURIComponent(VINCENT_CONFIG.redirectUrl)}`
            ];
            
            console.log('Available Vincent consent URLs:');
            consentUrls.forEach((url, index) => {
                console.log(`${index + 1}. ${url}`);
            });
            
            // Try the first URL
            const consentUrl = consentUrls[0];
            console.log('Trying Vincent consent:', consentUrl);
            
            // Open in new tab instead of redirect
            const newWindow = window.open(consentUrl, '_blank');
            if (!newWindow) {
                alert('Pop-up blocked. Please allow pop-ups or manually navigate to: ' + consentUrl);
            }
        }

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const resultDiv = document.getElementById('urlParams');
            
            const params = {};
            urlParams.forEach((value, key) => {
                params[key] = value;
            });

            if (Object.keys(params).length === 0) {
                resultDiv.innerHTML = '<p>No URL parameters found. You may need to complete the consent flow first.</p>';
                return;
            }

            let html = '<h4>URL Parameters Found:</h4><div class="token-display">';
            for (const [key, value] of Object.entries(params)) {
                html += `<strong>${key}:</strong> ${value}<br>`;
            }
            html += '</div>';

            // Check for JWT or authorization code
            if (params.jwt) {
                try {
                    const decoded = JSON.parse(atob(params.jwt.split('.')[1]));
                    if (decoded.pkp && decoded.pkp.tokenId) {
                        html += `<div class="success">‚úÖ PKP Token ID Found: ${decoded.pkp.tokenId}</div>`;
                        updateEnvDisplay(decoded.pkp.tokenId);
                    }
                } catch (e) {
                    html += '<div class="error">‚ùå Error decoding JWT</div>';
                }
            }

            if (params.code) {
                html += '<div class="success">‚úÖ Authorization code received. You may need to exchange this for a JWT token.</div>';
            }

            resultDiv.innerHTML = html;
        }

        function extractTokenFromStorage() {
            const resultDiv = document.getElementById('tokenResult');
            let html = '<h4>Checking Browser Storage:</h4>';
            
            // Check localStorage
            const localStorageKeys = ['vincent_pkp_token_id', 'vincent_user_info', 'lit_auth_token'];
            let found = false;
            
            for (const key of localStorageKeys) {
                const value = localStorage.getItem(key);
                if (value) {
                    html += `<div class="token-display"><strong>${key}:</strong> ${value}</div>`;
                    found = true;
                    
                    // Try to extract PKP token ID
                    if (key === 'vincent_pkp_token_id') {
                        updateEnvDisplay(value);
                    } else if (key === 'vincent_user_info') {
                        try {
                            const userInfo = JSON.parse(value);
                            if (userInfo.pkpTokenId) {
                                html += `<div class="success">‚úÖ PKP Token ID Found: ${userInfo.pkpTokenId}</div>`;
                                updateEnvDisplay(userInfo.pkpTokenId);
                            }
                        } catch (e) {
                            html += '<div class="error">‚ùå Error parsing user info</div>';
                        }
                    }
                }
            }
            
            if (!found) {
                html += '<p>No Vincent tokens found in localStorage. You may need to complete the consent flow first.</p>';
            }
            
            resultDiv.innerHTML = html;
        }

        function updateEnvDisplay(tokenId) {
            const envDiv = document.getElementById('envUpdate');
            envDiv.innerHTML = `
                <div class="success">‚úÖ Update your .env file with this PKP Token ID:</div>
                <div class="token-display">VINCENT_PKP_TOKEN_ID=${tokenId}</div>
                <p>Copy the line above and replace the existing VINCENT_PKP_TOKEN_ID line in your .env file.</p>
            `;
        }

        // Auto-check URL parameters on page load
        window.onload = function() {
            checkUrlParams();
        };
    </script>
</body>
</html>